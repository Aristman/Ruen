package ru.marslab.ruen.wordrepetition.viewmodels

import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import ru.marslab.ruen.wordrepetition.domain.Card
import ru.marslab.ruen.wordrepetition.domain.Translation
import ru.marslab.ruen.wordrepetition.exceptions.NoTranslationProvidedException
import ru.marslab.ruen.wordrepetition.repositories.ICardRepository
import javax.inject.Inject

@HiltViewModel
class CardAddViewModel @Inject constructor(
    private val repository: ICardRepository
) : ViewModel() {

    private val liveData = MutableLiveData<AppState>()
    private var card: Card? = null

    fun getLiveData(): LiveData<AppState> = liveData

    fun init(card: Card) {
        this.card = card
        liveData.postValue(AppState.Init(card))
    }

    fun save(translations: List<String>, customTranslate: String) {
        val trimedTranslation = customTranslate.trim()
        if (translations.isEmpty() && trimedTranslation.isEmpty()) {
            liveData.postValue(AppState.Error(NoTranslationProvidedException()))
            return
        }
        card?.let { it ->
            it.translations?.apply {
                clear()
                addAll(translations.map { return@map Translation(value = it) })
            }
            if (trimedTranslation.isNotEmpty()) {
                it.translations?.add(Translation(value = trimedTranslation))
            }
            viewModelScope.launch(Dispatchers.IO) {
                repository.save(it)
                withContext(Dispatchers.Main) {
                    liveData.postValue(AppState.SavedSuccess)
                }
            }
        }
    }

    sealed class AppState {
        data class Init(val card: Card) : AppState()
        data class Error(val exception: Throwable) : AppState()
        object SavedSuccess : AppState()
    }
}
